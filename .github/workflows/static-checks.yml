name: Static Checks

on:
  push:
    branches: [main]
  pull_request:

jobs:
  static:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Bash syntax
        run: bash -n scripts/*.sh

      - name: ShellCheck
        run: shellcheck -x scripts/*.sh

      - name: Retry helper self-test
        run: bash tests/retry-helper-test.sh

      - name: Text chunking dry-run self-test
        run: bash tests/text-chunking-dryrun-test.sh

      - name: JSON tools self-test
        run: bash tests/json-tools-test.sh

      - name: Help flags self-test
        run: bash tests/help-flags-test.sh

      - name: Dry-run smoke tests (no auth)
        run: bash tests/dry-run-smoke-test.sh

      - name: Template engine self-test
        run: bash tests/template-engine-test.sh

      - name: Web search filter self-test
        run: bash tests/web-search-filter-test.sh

      - name: Python compile
        run: python3 -m py_compile lib/*.py

      - name: Install jsonschema (for schema validation)
        run: python3 -m pip install --disable-pip-version-check --no-cache-dir jsonschema

      - name: Validate template JSON
        run: |
          python3 - <<'PY'
          import json
          import pathlib

          for p in pathlib.Path("templates").rglob("*.json"):
            with p.open("r", encoding="utf-8") as f:
              json.load(f)
          print("templates JSON: ok")
          PY

      - name: Validate templates against schema
        run: |
          while IFS= read -r f; do
            ./scripts/validate-json.sh --schema schemas/template.schema.json --file "$f" >/dev/null
          done < <(find templates -type f -name '*.json' -print)
